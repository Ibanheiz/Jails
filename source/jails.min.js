define(function(){function t(t){function n(t){var n;return t.trigger("get-instance",function(t){n=t}),n||{}}return{execute:function(e,i){i=Array.prototype.slice.call(arguments),i.shift();var a=n(t.eq(0));a[e]&&a[e].apply(a,i)},broadcast:function(i,a){a=Array.prototype.slice.call(arguments),a.shift(),t.each(function(){var t=n(e(this));t[i]&&t[i].apply(t,a)})},instance:function(){return n(t.eq(0))}}}var n,e,i,a={};n={config:{templates:{type:"x-tmpl-mustache"}},context:null,start:function(t,a){e=t.base,n.context=e(document.documentElement),i=e("<i />"),e.extend(!0,n.config,t),r.start(a),n.context.addClass("ready")},refresh:function(t){r.start(t)},data:function(){return a}};var r={start:function(t){var e,i=[];t=t||n.context,e=n.config.templates.type,r.scan("partial","script[type="+e+"]",t,i),r.scan("component","[data-component]",t,i),r.scan("view","[data-view]",t,i),r.scan("controller","[data-controller]",t,i),r.scan("app","[data-app]",t,i),s.start(i)},scan:function(t,i,a,s){a=a||n.context;var o,c,l,u;c=a.get(0).querySelectorAll(i),l=c.length;for(var f=0;l>f;f++)o=e(c[f]),u=r[t],u?u(t,o,s):r.module(t,o,s)},module:function(t,e,i){var r,o,c="s";r=e.data(t),o=n[t+c][r],o=o?new o(e,a):new s[t]._class(r,e,t),i.push(o)},partial:function(t,i){var a=n.config.templates.prefix,r=i.prop("id").split(a||"tmpl-").pop();n.templates[r]=e.trim(i.html())},component:function(t,i,a){var r,o,c;r=i.data(t),o=r.replace(/\s/g,"").split(/\,/),e.each(o,function(e,r){c=n.components[r],c=c?new c(i):new s[t]._class(r,i),a.push(c)})}},s={start:function(t){for(var n=t.length,e=0;n>e;e++)t[e].init&&t[e].init();t=null},common:{_class:function(n,a){var r=this;this.name=n,a.on("get-instance",function(t,n){n(r),t.stopPropagation()}),this.get=function(n,e){var i;return i=a.find(e?"[data-"+n+'*="'+e+'"]':"[data-"+n+"]"),t(i)},this.watch=function(t,n,e){a.on(n,t,e)},this.broadcast=function(t,n){e(t).trigger(n)},this.listen=function(t,n){a.on(t,function(t,e){n.apply(e.element,[t].concat(e.args))})},this.emit=function(t,e){e=Array.prototype.slice.call(arguments),e.shift(),a.trigger(n+":"+t,{args:e,element:a.get(0)})},this.publish=function(t,n){n=Array.prototype.slice.call(arguments),n.shift(),i.trigger(t,{args:n,element:a.get(0)})},this.subscribe=function(t,n){i.on(t,function(t,e){n.apply(e.element,[t].concat(e.args))})}}},app:{_class:function(t,n){s.common._class.apply(this,[t,n])}},controller:{_class:function(t,n){s.common._class.apply(this,[t,n])}},view:{_class:function(t,i){function o(t){return t?f[t]:null}function c(t){var n=t.html(),i=e("<div />"),a=e("<div />");return a.append(n),a.find("[data-if]").each(function(){var t=e(this),n=t.data("if");t.before("{{#"+n+"}}"),t.after("{{/"+n+"}}")}),a.find("[data-not]").each(function(){var t=e(this),n=t.data("not");t.before("{{^"+n+"}}"),t.after("{{/"+n+"}}")}),a.find("[data-each]").each(function(){var t=e(this),n=t.children().eq(0),a=t.data("each");i.empty().append(n),t.html("{{#"+a+"}}"+i.html()+"{{/"+a+"}}")}),a.find("[data-value]").each(function(){var t=e(this),n=t.data("value"),i=n.split(/\:/);t.html(i[1]?"{{#"+i[1]+"}}{{"+i[0]+"}}{{/"+i[1]+"}}":"{{"+n+"}}")}),a.find("[data-out]").each(function(){e(this).before("{{#out}}").after("{{/out}}")}),e.trim(a.html().replace(/(data-attr)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,function(t,n,e){return e}))}s.common._class.apply(this,[t,i]);var l,u,f,h,p=this;u=n.config.templates,f=n.templates,l=o(i.data("template"))||c(i),h=i.data("render"),this.template=function(t,n){return u.engine.render(o(n),t,f)},this.render=function(t,n){var e=n||l;this.partial(i,e,t)},this.partial=function(t,i,a){var s,o;a=a||{},i=f[i]||i,a&&a.done?a.done(function(n){p.partial(t,i,n)}):(s=e.extend({},a,n.filters),o=u.engine.render(i||l,s,f),t.html(o),r.start(t))},h?this.render(a):null}},model:{_class:function(t){var n={};this.name=t,this.data=function(t,i){return t?(n=t,i&&this.transform(i,t),e?e(this).trigger("change",n):null,void 0):n},this.on=function(t,n){e(this).on(t,function(t,e){n.call(this,e)})},this.trigger=function(t,n){e(this).trigger(t,n)},this.find=function(t){return n[t]},this.remove=function(t){delete n[t],this.trigger("change",n)},this.update=function(t,e){n[t]=e,this.trigger("change",n)},this.to_array=function(){return e.map(n,function(t){return[t]})},this.transform=function(t,e){e=e||n,e=e.push?e:[e];var i,a,r={},s=e.length;for(i=0;s>i;i++)a=e[i],r[a[t||i]]=a;count=i,n=r}}},component:{_class:function(t,n){this.name=t;var e=this;n.on("get-instance",function(t,n){n(e),t.stopPropagation()}),this.emit=function(e,i){i=Array.prototype.slice.call(arguments),i.shift(),n.trigger(t+":"+e,{args:i,element:n.get(0)})}}}},o={_class:function(){function t(t,e,i){return this instanceof n[t]?void s[t]._class.call(this,arguments[2],arguments[1]):this[t+"s"][e]=function(n,a){s[t]._class.call(this,e,n),i.call(this,n,a)}}this.apps={},this.controllers={},this.views={},this.models={},this.components={},this.templates={},this.filters={},this.controller=function(n,e){return t.call(this,"controller",n,e)},this.component=function(n,e){t.call(this,"component",n,e)},this.view=function(n,e){t.call(this,"view",n,e)},this.app=function(n,e){t.call(this,"app",n,e)},this.filter=function(t,n){this.filters[t]=function(){return function(t,e){return n(e(t))}}},this.model=function(t,e){if(!(this instanceof n.model)){n.models[t]=e;var i=new s.model._class(t);return e.apply(i),i}s.model._class.call(this,t)},this.filter("out",function(t){var n=e(t),i=e("<div />"),a=n.data("out");return n.html(new Function("return "+a)()),i.append(n),i.html()})}};return o._class.apply(n),n});
