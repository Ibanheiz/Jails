define(function(){function t(t){var n=t.html(),e=i("<div />"),a=i("<div />");return a.append(n),a.find("[data-if]").each(function(){var t=i(this),n=t.data("if");t.before("{{#"+n+"}}"),t.after("{{/"+n+"}}")}),a.find("[data-not]").each(function(){var t=i(this),n=t.data("not");t.before("{{^"+n+"}}"),t.after("{{/"+n+"}}")}),a.find("[data-each]").each(function(){var t=i(this),n=t.children().eq(0),a=t.data("each");e.empty().append(n),t.html("{{#"+a+"}}"+e.html()+"{{/"+a+"}}")}),a.find("[data-value]").each(function(){var t=i(this),n=t.data("value"),e=n.split(/\:/);t.html(e[1]?"{{#"+e[1]+"}}{{"+e[0]+"}}{{/"+e[1]+"}}":"{{"+n+"}}")}),a.find("[data-out]").each(function(){i(this).before("{{#out}}").after("{{/out}}")}),i.trim(a.html().replace(/(data-attr)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,function(t,n,e){return e}))}function n(t){return t.split(/\//).pop().split(/\./).shift()}var e,i,a,s,r={};s=Array.prototype.slice,e={config:{templates:{type:"x-tmpl-mustache"}},context:null,start:function(t,n){i=t.base,e.context=i(document.documentElement),a=i("<i />"),i.extend(!0,e.config,t),o.start(n),e.context.addClass("ready")},refresh:function(t){o.start(t)},data:function(){return r}};var o={start:function(t){var n,i=[];t=t||e.context,n=e.config.templates.type,o.scan("partial","script[type="+n+"]",t,i),o.scan("component","[data-component]",t,i),o.scan("controller","[data-controller]",t,i),o.scan("app","[data-app]",t,i),c.start(i)},scan:function(t,n,a,s){a=a||e.context;var r,c,l,u;c=a.get(0).querySelectorAll(n),l=c.length;for(var f=0;l>f;f++)r=i(c[f]),u=o[t],u?u(t,r,s):o.module(t,r,s)},module:function(t,n,i){var a,s,o="s";a=n.data(t),s=e[t+o][a],s=s?new s(n,r):new c[t]._class(a,n,t),i.push(s)},partial:function(t,n){var a=e.config.templates.prefix,s=n.prop("id").split(a||"tmpl-").pop();e.templates[s]=i.trim(n.html())},component:function(t,n,a){var s,r,l,u;s=n.data(t),u=o.annotations(s,n),r=s.replace(/\s/g,"").split(/\,/),i.each(r,function(i,s){l=e.components[s],l=l?new l(n,s in u?u[s]:{}):new c[t]._class(s,n),a.push(l)})},annotations:function(t,n){var e,i,a={};return e=n.get(0).previousSibling,e=e?e.previousSibling:null,e&&8==e.nodeType&&(i=e.data.replace(/\@(.*)\((\{.*\})\)/g,function(t,n,e){a[n]=new Function("return "+e)()})),a}},c={start:function(t){for(var n=t.length,e=0;n>e;e++)t[e].init&&t[e].init();t=null},common:{_class:function(t,n){var e=this;this.name=t,n.on("execute",function(n,i){var a=[].concat(i.args),s=a.shift(),r=e[s];r?r.apply(e,a):console.warn("Jails@warning =>",t,"has no method :",s),n.stopPropagation()})}},app:{_class:function(t,n){c.common._class.apply(this,[t,n]);var e=n.get(0);this.watch=function(t,e,i){n.on(e,t,i)},this.x=function(t){return t=n.find(t),function(){var n=s.call(arguments);t.trigger("execute",{args:n})}},this.listen=function(t,e){n.on(t,function(t,n){e.apply(n.element,[t].concat(n.args))})},this.emit=function(i,a){a=s.call(arguments),a.shift(),n.trigger(t+":"+i,{args:a,element:e})},this.publish=function(t,n){n=s.call(arguments),n.shift(),a.trigger(t,{args:n,element:e})},this.subscribe=function(t,n){a.on(t,function(t,e){n.apply(e.element,[t].concat(e.args))})}}},controller:{_class:function(t,n){c.app._class.apply(this,[t,n]),n.is("[data-template]")&&c.view._class.apply(this,[t,n])}},view:{_class:function(n,a){function s(t){return t?u[t]:null}var c,l,u,f,p=this;l=e.config.templates,u=e.templates,c=s(a.data("template"))||t(a),f=a.data("render"),this.template=function(t,n){return l.engine.render(s(n),t,u)},this.render=function(t,n){var e=n||c;this.partial(a,e,t)},this.partial=function(t,n,a){var s,r;a=a||{},n=u[n]||n,a&&a.done?a.done(function(e){p.partial(t,n,e)}):(s=i.extend({},a,e.filters),r=l.engine.render(n||c,s,u),t.html(r),o.start(t))},f?this.render(r):null}},model:{_class:function(t){var n={};this.name=t,this.data=function(t,e){return t?(n=t,e&&(n=this.transform(e,t)),i?i(this).trigger("change",n):null,void 0):n},this.on=function(t,n){i(this).on(t,function(t,e){n.call(this,e)})},this.trigger=function(t,n){i(this).trigger(t,n)},this.find=function(t){return n[t]},this.remove=function(t){delete n[t],this.trigger("change",n)},this.update=function(t,e){n[t]=e,this.trigger("change",n)},this.to_array=function(){return i.map(n,function(t){return[t]})},this.transform=function(t,e){e=e||n,e=e.push?e:[e];var i,a,s={},r=e.length;for(i=0;r>i;i++)a=e[i],s[a[t||i]]=a;return count=i,s}}},component:{_class:function(t,n){c.common._class.apply(this,[t,n]),this.emit=function(e,i){i=s.call(arguments),i.shift(),n.trigger(t+":"+e,{args:i,element:n.get(0)})},this.listen=function(t,e){n.on(t,function(t,n){e.apply(n.element,[t].concat(n.args))})}}}},l={_class:function(){function t(t,n,i){return this instanceof e[t]?void c[t]._class.call(this,arguments[2],arguments[1]):this[t+"s"][n]=function(e,a){c[t]._class.call(this,n,e),i.call(this,e,a)}}this.apps={},this.controllers={},this.models={},this.components={},this.templates={},this.filters={},this.template={promises:{},load:function(t,a){var s,r,o;return a=a||n(t),s=e.templates,r=s[a],pm=this.promises[a],r?r:pm?pm:(o=i.get(t).done(function(t){s[a]=t}),this.promises[a]=o,o)}},this.controller=function(n,e){return t.call(this,"controller",n,e)},this.component=function(n,e){t.call(this,"component",n,e)},this.app=function(n,e){t.call(this,"app",n,e)},this.filter=function(t,n){this.filters[t]=function(){return function(t,e){return n(e(t))}}},this.model=function(t,n){if(!(this instanceof e.model)){e.models[t]=n;var i=new c.model._class(t);return n.apply(i),i}c.model._class.call(this,t)},this.filter("out",function(t){var n=i(t),e=i("<div />"),a=n.data("out");return n.html(new Function("return "+a)()),e.append(n),e.html()})}};return l._class.apply(e),e});
