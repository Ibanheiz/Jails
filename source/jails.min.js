define(function(){function s(e){function t(e){var t;e.trigger("get-instance",function(e){t=e});return t||{}}return{execute:function(n,r){r=Array.prototype.slice.call(arguments);r.shift();var i=t(e.eq(0));if(i[n])i[n].apply(i,r)},broadcast:function(r,i){i=Array.prototype.slice.call(arguments);i.shift();e.each(function(){var e=t(n(this));if(e[r])e[r].apply(e,i)})},instance:function(){return t(e.eq(0))}}}var e,t,n;e={config:{templates:{type:"x-tmpl-mustache"}},context:null,start:function(t,i){n=t.base;e.context=n(document.documentElement);n.extend(true,e.config,t);r.start(i)},refresh:function(e){r.start(e)}};var r={start:function(t){var n,s=[];t=t||e.context;n=e.config.templates.type;r.scan("partial","script[type="+n+"]",t,s);r.scan("component","[data-component]",t,s);r.scan("view","[data-view]",t,s);r.scan("controller","[data-controller]",t,s);r.scan("app","[data-app]",t,s);i.start(s)},scan:function(t,i,s,o){s=s||e.context;var u,a,f,l;a=s.get(0).querySelectorAll(i);f=a.length;for(var c=0;c<f;c++){u=n(a[c]);l=r[t];l?l(t,u,o):r.module(t,u,o)}},module:function(t,n,r){var s,o,u,a="s";s=n.data(t);o=new i[t]._class(s,n,t);u=e[t+a][s];u?u.apply(o,[n]):null;r.push(o)},partial:function(t,r){var i=e.config.templates.prefix;var s=r.prop("id").split(i||"tmpl-").pop();e.templates[s]=n.trim(r.html())},component:function(t,r,s){var o,u,a,f;o=r.data(t);u=o.replace(/\s/g,"").split(/\,/);n.each(u,function(n,o){a=new i[t]._class(o,r);f=e.components[o];f?f.apply(a,[r]):null;s.push(a)})}};var i={start:function(e){var t=e.length;for(var n=0;n<t;n++)if(e[n].init)e[n].init();e=null},common:{_class:function(e,t){var r=this,i;this.name=e;t.on("get-instance",function(e,t){t(r);e.stopPropagation()});this.get=function(e,n){var r;if(n)r=t.find("[data-"+e+'*="'+n+'"]');else r=t.find("[data-"+e+"]");return s(r)};this.data=function(e){if(e){this.get("view").broadcast("render",e);i=e}else return i};this.watch=function(e,n,r){t.on(n,e,r)};this.broadcast=function(e,t){n(e).trigger(t)};this.listen=function(e,n){t.on(e,function(e,t){n.apply(t.element,[e].concat(t.args))})};this.emit=function(n,r){r=Array.prototype.slice.call(arguments);r.shift();t.trigger(e+":"+n,{args:r,element:t.get(0)})}}},app:{_class:function(e,t){i.common._class.apply(this,[e,t])}},controller:{_class:function(e,t){i.common._class.apply(this,[e,t])}},view:{_class:function(t,n){function l(e){return u[e]}i.common._class.apply(this,[t,n]);var s,o,u,a,f=this;s=n.data("template");a=n.data("render");o=e.config.templates;u=e.templates;this.template=function(e,t){return o.engine.render(l(t),e,u)};this.render=function(e,t){s=t||s;if(s&&u[s])this.partial(n,s,e)};this.partial=function(e,t,n){if(u[t]){var i=o.engine.render(l(t),n,u);e.html(i);r.start(e)}};a?this.render({}):null}},model:{_class:function(e,t){var r,i=this,s,o=document.createElement("i");s=0;this.name=e;this.data=function(t,i){if(t){r=t;if(i)this.transform(i,t);n(o).trigger(e+":change",r)}else return r};this.size=function(){return r.length||s};this.find=function(e){return r[e]};this.remove=function(t){delete r[t];n(o).trigger(e+":change",r)};this.update=function(t,i){r[t]=i;n(o).trigger(e+":change",r)};this.emit=function(t,r){n(t).trigger(e+":"+t,r)};this.transform=function(e,t){t=t||r;t=t.push?t:[t];var n={},i=t.length,o,u;for(o=0;o<i;o++){u=t[o];n[u[e||o]]=u}s=o;r=n};this.rules={type:function(e){var t,r;n.each(i.schema,function(n,s){if(!e[n]&&i.required[n]){console.log("Model::"+i.name+"."+n+" is missing or it's null, but it should have some value");return false}if(e[n]){t=e[n].constructor.name;r=s.name;if(t!=r){console.log("Model::"+i.name+"."+n+" is ["+t+"] it should be => ["+r+"]");return false}}});return true}}}},component:{_class:function(e,t){this.name=e;var n=this;t.on("get-instance",function(e,t){t(n);e.stopPropagation()});this.emit=function(n,r){r=Array.prototype.slice.call(arguments);r.shift();t.trigger(e+":"+n,{args:r,element:t.get(0)})}}}};var o={_class:function(){this.apps={};this.controllers={};this.views={};this.models={};this.components={};this.templates={};this.controller=function(e,t){this.controllers[e]=t},this.component=function(e,t){this.components[e]=t},this.view=function(e,t){this.views[e]=t},this.app=function(e,t){this.apps[e]=t},this.model=function(t,n){e.models[t]=n;var r=new i.model._class(t);n.apply(r);return r}}};o._class.apply(e);return e})
